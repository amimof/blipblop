syntax = "proto3";

package services.nodes.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/wrappers.proto";
import "services/events/v1/events.proto";
import "services/volumes/v1/volumes.proto";
import "types/v1/conditions.proto";
import "types/v1/meta.proto";

option go_package = "github.com/amimof/voiyd/api/services/nodes/v1;nodes";

service NodeService {
  rpc List(ListRequest) returns (ListResponse) {
    option (google.api.http) = {get: "/api/v1/nodes"};
  }
  rpc Get(GetRequest) returns (GetResponse) {
    option (google.api.http) = {get: "/api/v1/nodes/{id}"};
  }
  rpc Create(CreateRequest) returns (CreateResponse) {
    option (google.api.http) = {
      post: "/api/v1/nodes"
      body: "node"
    };
  }
  rpc Update(UpdateRequest) returns (UpdateResponse) {
    option (google.api.http) = {
      put: "/api/v1/nodes/{node.meta.name}"
      body: "node"
    };
  }
  rpc Patch(PatchRequest) returns (PatchResponse) {
    option (google.api.http) = {
      patch: "/api/v1/nodes/{node.meta.name}"
      body: "node"
    };
  }
  rpc Delete(DeleteRequest) returns (DeleteResponse) {
    option (google.api.http) = {delete: "/api/v1/nodes/{id}"};
  }
  rpc Join(JoinRequest) returns (JoinResponse) {}
  rpc Forget(ForgetRequest) returns (ForgetResponse) {}
  rpc Connect(stream services.events.v1.Event) returns (stream services.events.v1.Event) {}
  rpc UpdateStatus(UpdateStatusRequest) returns (UpdateStatusResponse) {
    option (google.api.http) = {put: "/api/v1/nodes/{id}/status"};
  }
  rpc Upgrade(UpgradeRequest) returns (UpgradeResponse) {}
  rpc Condition(types.v1.ConditionRequest) returns (google.protobuf.Empty) {}
}

message Node {
  string version = 1 [
    (buf.validate.field).string.min_len = 4,
    (buf.validate.field).string.pattern = "^[a-z0-9]+(?:[._-][a-z0-9]+)*/[a-z0-9]+(?:[._-][a-z0-9]+)*$",
    (buf.validate.field).required = true
  ];
  types.v1.Meta meta = 2 [(buf.validate.field).required = true];
  Config config = 3 [(buf.validate.field).required = true];
  Status status = 4;
}

message Config {
  VolumeConfig volume_drivers = 1;
}

message VolumeConfig {
  services.volumes.v1.VolumeDriverHostLocal host_local = 1;
  services.volumes.v1.VolumeDriverTemplate template = 2;
}

message Status {
  google.protobuf.StringValue phase = 1;
  google.protobuf.StringValue status = 2;
  IPStatus ip = 3;
  google.protobuf.StringValue hostname = 4;
  google.protobuf.StringValue runtime = 5;
  google.protobuf.StringValue version = 6;
  repeated types.v1.Condition conditions = 7;
}

message IPStatus {
  repeated IPLinkStatus links = 1;
  repeated IPV4Status addresses = 2;
  google.protobuf.StringValue dns = 3;
}

message IPLinkStatus {
  google.protobuf.StringValue link = 1;
  google.protobuf.StringValue state = 2;
  google.protobuf.StringValue mac = 3;
}

message IPV4Status {
  google.protobuf.StringValue address = 1;
  google.protobuf.StringValue netmask = 2;
  google.protobuf.StringValue gateway = 3;
  google.protobuf.StringValue interface = 4;
}

message DNSStatus {
  repeated google.protobuf.StringValue nameservers = 1;
}

message GetRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}

message GetResponse {
  Node node = 1;
}

message CreateRequest {
  Node node = 1 [(buf.validate.field).required = true];
}

message CreateResponse {
  Node node = 1;
}

message DeleteRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}

message DeleteResponse {
  string id = 1;
}

message UpdateRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  Node node = 2 [(buf.validate.field).required = true];
  google.protobuf.FieldMask update_mask = 3;
}

message UpdateResponse {
  Node node = 1;
}

message PatchRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
  Node node = 2 [(buf.validate.field).required = true];
  google.protobuf.FieldMask update_mask = 3;
}

message PatchResponse {
  Node node = 1;
}

message ListRequest {
  map<string, string> selector = 1;
}

message ListResponse {
  repeated Node nodes = 1;
}

message JoinRequest {
  Node node = 1 [(buf.validate.field).required = true];
}

message JoinResponse {
  string id = 1;
}

message ForgetRequest {
  string id = 1 [(buf.validate.field).string.min_len = 1];
}

message ForgetResponse {
  string id = 1;
}
message UpdateStatusRequest {
  string id = 1;
  google.protobuf.FieldMask update_mask = 2 [(buf.validate.field).required = true];
  Status status = 3 [(buf.validate.field).required = true];
}
message UpdateStatusResponse {
  string id = 1;
}
message UpgradeRequest {
  string target_version = 1 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.pattern = "^v?(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[A-Za-z-][0-9A-Za-z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[A-Za-z-][0-9A-Za-z-]*))*))?(?:\\+([0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*))?$"
  ];

  option (buf.validate.message).oneof = {
    fields: [
      "node_id",
      "node_selector"
    ]
  };
  string node_id = 2 [(buf.validate.field).string.min_len = 1];
  map<string, string> node_selector = 3;
}

message UpgradeResponse {}
