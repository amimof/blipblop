syntax = "proto3";

package services.nodes.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/api/client.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/wrappers.proto";
import "services/events/v1/events.proto";
import "services/logs/v1/logs.proto";
import "services/volumes/v1/volumes.proto";
import "types/v1/meta.proto";
import "validate/validate.proto";

option go_package = "github.com/amimof/blipblop/api/services/nodes/v1;nodes";

service NodeService {
  rpc List(ListRequest) returns (ListResponse) {
    option (google.api.http) = {get: "/api/v1/nodes"};
  }
  rpc Get(GetRequest) returns (GetResponse) {
    option (google.api.http) = {get: "/api/v1/nodes/{id}"};
  }
  rpc Create(CreateRequest) returns (CreateResponse) {
    option (google.api.http) = {
      post: "/api/v1/nodes"
      body: "node"
    };
  }
  rpc Update(UpdateRequest) returns (UpdateResponse) {
    option (google.api.http) = {
      put: "/api/v1/nodes/{node.meta.name}"
      body: "node"
    };
  }
  rpc Patch(PatchRequest) returns (PatchResponse) {
    option (google.api.http) = {
      patch: "/api/v1/nodes/{node.meta.name}"
      body: "node"
    };
  }
  rpc Delete(DeleteRequest) returns (DeleteResponse) {
    option (google.api.http) = {delete: "/api/v1/nodes/{id}"};
  }
  rpc Join(JoinRequest) returns (JoinResponse) {}
  rpc Forget(ForgetRequest) returns (ForgetResponse) {}
  rpc Connect(stream services.events.v1.Event) returns (stream services.events.v1.Event) {}
  rpc UpdateStatus(UpdateStatusRequest) returns (UpdateStatusResponse) {
    option (google.api.http) = {put: "/api/v1/nodes/{id}/status"};
  }
}

message Node {
  types.v1.Meta meta = 1 [(validate.rules).message.required = true];
  Config config = 2 [(validate.rules).message.required = true];
  Status status = 3;
}

message Config {
  VolumeConfig volume_drivers = 1;
}

message VolumeConfig {
  services.volumes.v1.VolumeDriverHostLocal host_local = 1;
  services.volumes.v1.VolumeDriverTemplate template = 2;
}

message Status {
  google.protobuf.StringValue phase = 1;
  IPStatus ip = 2;
  google.protobuf.StringValue hostname = 3;
  google.protobuf.StringValue runtime = 4;
}

message IPStatus {
  repeated IPLinkStatus links = 1;
  repeated IPV4Status addresses = 2;
  google.protobuf.StringValue dns = 3;
}

message IPLinkStatus {
  google.protobuf.StringValue link = 1;
  google.protobuf.StringValue state = 2;
  google.protobuf.StringValue mac = 3;
}

message IPV4Status {
  google.protobuf.StringValue address = 1;
  google.protobuf.StringValue netmask = 2;
  google.protobuf.StringValue gateway = 3;
  google.protobuf.StringValue interface = 4;
}

message DNSStatus {
  repeated google.protobuf.StringValue nameservers = 1;
}

message GetRequest {
  string id = 1 [(validate.rules).string.min_len = 1];
}

message GetResponse {
  Node node = 1;
}

message CreateRequest {
  Node node = 1 [(validate.rules).message.required = true];
}

message CreateResponse {
  Node node = 1;
}

message DeleteRequest {
  string id = 1 [(validate.rules).string.min_len = 1];
}

message DeleteResponse {
  string id = 1;
}

message UpdateRequest {
  string id = 1 [(validate.rules).string.min_len = 1];
  Node node = 2 [(validate.rules).message.required = true];
  google.protobuf.FieldMask update_mask = 3;
}

message UpdateResponse {
  Node node = 1;
}

message PatchRequest {
  string id = 1 [(validate.rules).string.min_len = 1];
  Node node = 2 [(validate.rules).message.required = true];
  google.protobuf.FieldMask update_mask = 3;
}

message PatchResponse {
  Node node = 1;
}

message ListRequest {
  map<string, string> selector = 1;
}

message ListResponse {
  repeated Node nodes = 1;
}

message JoinRequest {
  Node node = 1 [(validate.rules).message.required = true];
}

message JoinResponse {
  string id = 1;
}

message ForgetRequest {
  string id = 1 [(validate.rules).string.min_len = 1];
}

message ForgetResponse {
  string id = 1;
}
message UpdateStatusRequest {
  string id = 1;
  google.protobuf.FieldMask update_mask = 2 [(validate.rules).message.required = true];
  Status status = 3 [(validate.rules).message.required = true];
}
message UpdateStatusResponse {
  string id = 1;
}
